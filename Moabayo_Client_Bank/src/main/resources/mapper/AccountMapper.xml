<!-- resources/mapper/AccountMapper.xml -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sboot.moabayo.dao.AccountMapper">

  <!-- ê³„ì¢Œ + ìµœê·¼ë‚´ì—­ resultMap -->
  <resultMap id="AccountWithHistoryMap" type="com.sboot.moabayo.vo.AccountVO">
    <id     column="ID"          property="id"/>
    <result column="ICON"        property="icon"/>
    <result column="NAME"        property="name"/>
    <result column="ACCOUNT_NO"  property="number"/>
    <result column="PRODUCT"     property="product"/>
    <result column="TYPE"        property="type"/>
    <result column="BALANCE"     property="balance"/>
    <result column="OPENED_AT"   property="openedAt"/>
    <collection property="history" ofType="com.sboot.moabayo.vo.TxVO"
                column="ID" select="selectHistoryByUserAccountId"/>
  </resultMap>

  <!-- ê³µí†µ SELECT ì»¬ëŸ¼ -->
  <sql id="AccountSelectColumns">
    ua.user_account_id AS ID,

    /* ì•„ì´ì½˜ì€ type ê¸°ë°˜ ë§¤í•‘ */
    CASE UPPER(bp.type)
      WHEN 'DEPOSIT' THEN 'ğŸ’³'
      WHEN 'SAVINGS' THEN 'ğŸ¦'
      WHEN 'LOAN'    THEN 'ğŸ“„'
      ELSE 'ğŸ’°'
    END AS ICON,

    NVL(ua.account_name, 'ë‚´ í†µì¥') AS NAME,
    ua.account_number AS ACCOUNT_NO,
    bp.name AS PRODUCT,
    bp.type AS TYPE,

    /* ì”ì•¡: ì…ê¸ˆê³„ì—´ +, ì¶œê¸ˆê³„ì—´ - */
    NVL(ua.balance, 0) AS BALANCE,

    /* ê°œì„¤ì¼: ì²« ê±°ë˜ì¼ì (ì—†ìœ¼ë©´ NULL) */
    ua.create_date AS OPENED_AT
  </sql>

  <!-- ì‚¬ìš©ì ê³„ì¢Œ (ë‚´ì—­ í¬í•¨) -->
  <select id="findAccountsWithHistoryByUserId" resultMap="AccountWithHistoryMap" parameterType="long">
    SELECT
      <include refid="AccountSelectColumns"/>
    FROM user_account ua
    JOIN bank_product bp ON bp.account_id = ua.account_id
    WHERE ua.user_id = #{userId}
    ORDER BY ua.user_account_id DESC
  </select>

  <!-- ì‚¬ìš©ì ê³„ì¢Œ (ë‚´ì—­ ì œì™¸) -->
  <resultMap id="AccountOnlyMap" type="com.sboot.moabayo.vo.AccountVO">
    <id     column="ID"          property="id"/>
    <result column="ICON"        property="icon"/>
    <result column="NAME"        property="name"/>
    <result column="ACCOUNT_NO"  property="number"/>
    <result column="PRODUCT"     property="product"/>
    <result column="TYPE"        property="type"/>
    <result column="BALANCE"     property="balance"/>
    <result column="OPENED_AT"   property="openedAt"/>
  </resultMap>

  <select id="findAccountsByUserId" resultMap="AccountOnlyMap" parameterType="long">
    SELECT
      <include refid="AccountSelectColumns"/>
    FROM user_account ua
    JOIN bank_product bp ON bp.account_id = ua.account_id
    WHERE ua.user_id = #{userId}
    ORDER BY ua.user_account_id DESC
  </select>

  <!-- ìµœê·¼ ê±°ë˜ë‚´ì—­ Nê°œ: ts/type/amount/bal(ëŸ¬ë‹ë°¸ëŸ°ìŠ¤) -->
  <select id="selectHistoryByUserAccountId" parameterType="long" resultType="com.sboot.moabayo.vo.TxVO">
    SELECT
      TO_CHAR(t.date_time, 'YYYY-MM-DD HH24:MI') AS ts,

      /* í™”ë©´ì— ë³´ì¼ ë¼ë²¨: í•„ìš”ì‹œ í•œê¸€ CASE ë¡œ ì¹˜í™˜ */
      t.account_type AS type,

      /* ë¶€í˜¸ í¬í•¨ ê¸ˆì•¡(ì› ë‹¨ìœ„) */
      TRUNC(
        CASE
          WHEN UPPER(t.account_type) IN ('DEPOSIT','INCOME','TRANSFER_IN','ì…ê¸ˆ','ì´ì²´ìˆ˜ì‹ ')
            THEN t.approved_amount
          ELSE -t.approved_amount
        END
      ) AS amount,

      /* ëŸ¬ë‹ ë°¸ëŸ°ìŠ¤(ì› ë‹¨ìœ„) */
      TRUNC(SUM(
        CASE
          WHEN UPPER(t.account_type) IN ('DEPOSIT','INCOME','TRANSFER_IN','ì…ê¸ˆ','ì´ì²´ìˆ˜ì‹ ')
            THEN t.approved_amount
          ELSE -t.approved_amount
        END
      ) OVER (
        PARTITION BY t.user_account_id
        ORDER BY t.date_time
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )) AS bal

    FROM account_transaction t
    WHERE t.user_account_id = #{userAccountId}
    ORDER BY t.date_time DESC
    FETCH FIRST 10 ROWS ONLY
  </select>
<!-- ì–´ì¹´ìš´íŠ¸ ë„˜ë²„(ìœ ë‹ˆí¬) ë¡œ ìœ ì €ì°¾ê¸° -->
<select id="findUserByAccountNumber" resultType="com.sboot.moabayo.vo.UserVO">
  SELECT 
    u.user_id           AS userId,
    TO_CHAR(u.create_date, 'YYYY-MM-DD') AS createDate,
    u.account_num       AS accountNum,
    u.address           AS address,
    u.address_detail    AS addressDetail,
    u.zip_code          AS zipCode,
    u.email             AS email,
    u.name              AS name,
    u.login_id          AS loginId,
    u.password          AS password,
    u.phone             AS phone,
    u.refresh_token     AS refreshToken,
    u.is_admin          AS isAdmin
  FROM users u
  JOIN user_account ua
    ON ua.user_id = u.user_id
  WHERE ua.account_number = #{accNum, jdbcType=VARCHAR}
</select>

<!-- ì‚¬ìš©ì ê³„ì¢Œ ëª©ë¡(ë“œë¡­ë‹¤ìš´) -->
<select id="findSimpleAccountsByUserId" parameterType="long" resultType="map">
  SELECT
    ua.user_account_id AS user_account_id,
    ua.account_name    AS account_name,
    ua.account_number  AS account_number,
    ua.balance         AS balance
  FROM user_account ua
  WHERE ua.user_id = #{userId}
  ORDER BY ua.create_date DESC
</select>

<!-- ê³„ì¢Œë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ -->
<select id="existsAccountNumber" parameterType="string" resultType="int">
  SELECT COUNT(1) FROM user_account WHERE account_number = #{accountNumber}
</select>

<!-- ì‹ ê·œ ê³„ì¢Œ INSERT (UserAccountVOë¥¼ ì“°ì§€ ì•Šê³  mapìœ¼ë¡œ ì•ˆì „í•˜ê²Œ) -->
<insert id="insertUserAccount" parameterType="map">
	<!-- Null ì´ ë“¤ì–´ê°€ëŠ” ì´ìŠˆ ë•Œë¬¸ì— -->
  <selectKey keyProperty="user_account_id" resultType="long" order="BEFORE">
    SELECT USER_ACCOUNT_ID_SEQ.NEXTVAL FROM dual
  </selectKey>
  INSERT INTO user_account (
    user_account_id, user_id, account_id, account_number, account_name, create_date, balance
  ) VALUES (
    #{user_account_id}, #{user_id}, #{account_id}, #{account_number}, #{account_name}, SYSDATE, #{balance}
  )
</insert>

</mapper>
